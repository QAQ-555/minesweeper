<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Minesweeper</title>
<style>
  #board-container {
    display: inline-block;
    margin-top: 20px;
  }
  #board {
    display: grid;
    gap: 2px;
  }
  .cell, .coord {
    width: 30px;
    height: 30px;
    text-align: center;
    line-height: 30px;
    user-select: none;
  }
  .cell {
    background: lightgray;
    cursor: pointer;
  }
  .coord {
    background: #ddd;
    font-weight: bold;
    cursor: default;
  }
</style>
</head>
<body>
<h1>Minesweeper</h1>

<div id="config">
  <label>X: <input type="number" id="x" value="3" /></label>
  <label>Y: <input type="number" id="y" value="2" /></label>
  <label>Mines: <input type="number" id="num" value="1" /></label>
  <button id="start">Start Game</button>
</div>

<div id="game" style="display:none;">
  <div id="board-container">
    <div id="board"></div>
  </div>
</div>

<script>
let ws;
let xSize, ySize;

// ç”¨äºç¼“å­˜å¤šä¸ªmsgidçš„æ•°æ®
const messageBuffers = new Map();

document.addEventListener("contextmenu", e => e.preventDefault());

document.getElementById('start').onclick = () => {
  xSize = parseInt(document.getElementById('x').value);
  ySize = parseInt(document.getElementById('y').value);
  const num = parseInt(document.getElementById('num').value);

  ws = new WebSocket("ws://localhost:8001/ws");

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: 0,
      id: "sss",
      payload: { x: xSize, y: ySize, num: num }
    }));

    document.getElementById('config').style.display = 'none';
    document.getElementById('game').style.display = 'block';

    createBoardWithCoords(xSize, ySize);
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 16 && msg.payload && msg.payload.msgid !== undefined) {
      handlePartialUpdate(msg.payload);
    } else {
      console.log("server:", e.data);
    }
  };
};

function createBoardWithCoords(x, y) {
  const board = document.getElementById('board');
  board.style.gridTemplateColumns = `30px repeat(${x}, 30px)`;
  board.innerHTML = '';

  const corner = document.createElement('div');
  corner.className = 'coord';
  board.appendChild(corner);

  for(let col=0; col < x; col++) {
    const coordX = document.createElement('div');
    coordX.className = 'coord';
    coordX.textContent = col;
    board.appendChild(coordX);
  }

  for(let row=0; row < y; row++) {
    const coordY = document.createElement('div');
    coordY.className = 'coord';
    coordY.textContent = row;
    board.appendChild(coordY);

    for(let col=0; col < x; col++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.x = col;
      cell.dataset.y = row;
      cell.dataset.flag = "false"; 
      cell.dataset.revealed = "false"; // æ–°å¢ revealed å±æ€§

      cell.onmousedown = (e) => {
        e.preventDefault();
        const isLeftClick = (e.button === 0);
        const isRightClick = (e.button === 2);

        if (isRightClick) {
          // å³é”®åªèƒ½åœ¨æœªæ­å¼€çš„æ ¼å­ä¸Šæ’æ——
          if (cell.dataset.revealed === "true") {
            return;
          }

          if (cell.dataset.flag === "false") {
            cell.dataset.flag = "true";
            cell.textContent = "ğŸš©";
            cell.style.backgroundColor = "lightyellow";
          } else {
            cell.dataset.flag = "false";
            cell.textContent = "";
            cell.style.backgroundColor = "lightgray";
          }
        } else if (isLeftClick) {
          if (cell.dataset.flag === "true") {
            // å¦‚æœæœ‰æ——å­ï¼Œå…ˆå–æ¶ˆæ——å­
            cell.dataset.flag = "false";
            cell.textContent = "";
            cell.style.backgroundColor = "lightgray";
          } else {
            // å‘é€æ­å¼€è¯·æ±‚
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({
                type: 15,
                id: "sss",
                payload: {
                  x: col,
                  y: row,
                  click: true
                }
              }));
            }
          }
        }
      };

      board.appendChild(cell);
    }
  }
}

// å¤„ç†åˆ†æ‰¹æ›´æ–°
function handlePartialUpdate(payload) {
  const { msgid, x, y, num, end } = payload;

  if (!messageBuffers.has(msgid)) {
    messageBuffers.set(msgid, []);
  }
  const buffer = messageBuffers.get(msgid);
  buffer.push({ x, y, num });

  if (end) {
    renderCells(buffer);
    messageBuffers.delete(msgid);
  }
}

function renderCells(cells) {
  for (const cell of cells) {
    const selector = `.cell[data-x="${cell.x}"][data-y="${cell.y}"]`;
    const elem = document.querySelector(selector);
    if (!elem) continue;

    // æ¸…é™¤æ——å­çŠ¶æ€
    elem.dataset.flag = "false";
    elem.dataset.revealed = "true"; // æ ‡è®°ä¸ºå·²æ­å¼€

    if (cell.num === 0) {
      elem.textContent = '';
      elem.style.backgroundColor = '#eee';
    } else if (cell.num === 9) { // 9æ˜¯æ——å­
      elem.textContent = 'ğŸš©';
      elem.style.backgroundColor = 'lightyellow';
      elem.dataset.flag = "true";
    } else if (cell.num === 10) { // 10æ˜¯é›·
      elem.textContent = 'ğŸ’£';
      elem.style.backgroundColor = 'lightcoral';
    } else {
      elem.textContent = cell.num;
      elem.style.backgroundColor = '#ddd';
    }
  }
}
</script>
</body>
</html>
